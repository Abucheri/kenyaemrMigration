select 

P.PersonId Person_Id,
P.Ptn_Pk,
t.Visit_Id,
format(cast(coalesce(t.DispensedByDate,t.OrderedByDate,t.VisitDate) AS DATE), 'yyyy-MM-dd') AS Encounter_Date,
NULL AS Encounter_ID,
NULL AS Visit_scheduled,
NULL AS Visit_by,
NULL Visit_by_other,
NULL AS Nutritional_status,
NULL AS Who_stage,
NULL AS Clinical_notes,
NULL as Last_menstrual_period,
NULL as Pregnancy_status,
NULL as Wants_pregnancy,
NULL as Pregnancy_outcome,
NULL as Anc_number,
NULL AS Anc_profile,
NULL  as Expected_delivery_date,
NULL as Gravida,
NULL as Parity_term,
NULL as Parity_abortion,
NULL as Family_planning_status,
NULL Reason_not_using_family_planning,
NULL as General_examinations_findings,
NULL as System_review_finding,
NULL as Skin,
NULL as Skin_finding_notes,
NULL as Eyes,
NULL as Eyes_Finding_notes,
NULL as ENT,
NULL as ENT_finding_notes,
NULL as Chest,
NULL as Chest_finding_notes,
NULL as CVS,
NULL as CVS_finding_notes,
NULL as Abdomen,
NULL as Abdomen_finding_notes,
NULL as CNS,
NULL as CNS_finding_notes,
NULL as Genitourinary,
NULL as Genitourinary_finding_notes,
NULL as Treatment_plan,
NULL as Ctx_adherence,
NULL as Ctx_dispensed,
NULL as Dapsone_adherence,
NULL as Dapsone_dispensed,
NULL Morisky_forget_taking_drugs,
NULL Morisky_careless_taking_drugs,
NULL Morisky_stop_taking_drugs_feeling_worse,
NULL Morisky_stop_taking_drugs_feeling_better,
NULL Morisky_took_drugs_yesterday,
NULL Morisky_stop_taking_drugs_symptoms_under_control,
NULL Morisky_feel_under_pressure_on_treatment_plan,
NULL Morisky_how_often_difficulty_remembering,
NULL as Arv_adherence,
NULL Condom_Provided,
NULL Screened_for_substance_abuse,
NULL Pwp_Disclosure,
NULL Pwp_partner_tested,
NULL as Cacx_Screening,
NULL Screened_for_sti,
NULL as Sti_partner_notification,
NULL as Stability,
format(cast(t.ExpectedReturn AS DATE), 'yyyy-MM-dd') AS Next_appointment_date,
NULL Next_appointment_reason,
NULL Appointment_type,
NULL as Differentiated_care,
NULL as Voided

from(SELECT dateadd(day, d.Duration, CASE WHEN o.OrderedByDate > o.DispensedByDate THEN o.OrderedByDate ELSE o.DispensedByDate END) AS ExpectedReturn, 
o.DispensedByDate, o.OrderedByDate,
o.Ptn_pk, ov.VisitDate, ov.VisitType, ov.Visit_Id
FROM ord_PatientPharmacyOrder o 
INNER JOIN ord_Visit ov ON ov.Visit_Id = o.VisitID
INNER JOIN dtl_PatientPharmacyOrder d ON d.ptn_pharmacy_pk = o.ptn_pharmacy_pk
WHERE ov.VisitType = 4 AND d.Prophylaxis = 0  AND o.ProgID IN (SELECT ID FROM mst_Decode WHERE Name IN ('ART', 'PMTCT')) AND o.DispensedByDate IS NOT NULL and o.PatientMasterVisitId is null) t
INNER JOIN Patient P ON P.ptn_pk = t.Ptn_Pk
left join( select 
vo.Ptn_Pk,
vo.VisitDate
FROM ord_Visit vo
WHERE vo.VisitType = 17) d on d.Ptn_Pk = t.Ptn_pk AND t.VisitDate = d.VisitDate
WHERE d.VisitDate is null
